---
title:  "Swift4.0:å°é²œä»¥åŠç¬¬ä¸€æ¬¡ç¿»è½¦çºªå¿µ"
date:   2017-06-07 18:32:01
categories: Swift4.0
---

æ˜¨å¤©å‡Œæ™¨WWDC2017åˆšå‘å¸ƒäº†Xcode9 BetaåŒ…å«äº†Swift4.0ï¼Œæ­£å¥½æœ€è¿‘åœ¨åšMacOSçš„é¡¹ç›®ï¼Œå› ä¸ºé¡¹ç›®æ˜¯ä¸ªäººçš„ï¼Œæ‰€ä»¥æœæ–­ç”¨æ¥å°é²œã€‚ä½†æ˜¯æœ€åè¿˜æ˜¯ç¿»è½¦äº†ã€‚æ‰€ä»¥å†™ä¸ªåšå®¢çºªå¿µæˆ‘åœ¨Swift4.0ç¿»çš„ç¬¬ä¸€æ¬¡è½¦ã€‚ğŸ˜‚





##åˆä½“éªŒ
4.0è¿™ä¸€æ¬¡æ›´æ–°çš„å…¼å®¹ç¨‹åº¦ç›¸æ¯”ä¹‹å‰2.3åˆ°3.0é‚£æ¬¡æ›´æ–°çœŸçš„å¯ä»¥è¯´æ˜¯å¾ˆè‰¯å¿ƒäº†ã€‚åœ¨ä¿®æ”¹äº†å·®ä¸å¤š30è¡Œä»£ç ï¼ŒèŠ±è´¹5åˆ†é’Ÿå·¦å³æ—¶é—´ä¹‹åï¼Œé¡¹ç›®å·²ç»å½»åº•å…¼å®¹äº†Swift4.0.è¿™ä¸ªç»“æœçœŸçš„è®©æˆ‘æƒŠè®¶ï¼Œè¿˜ä»¥ä¸ºéœ€è¦èŠ±è´¹ç‚¹åŠŸå¤«å‘¢ã€‚è‡³äºSwift4.0çš„ä¼˜åŒ–ç‚¹ï¼ŒiOSçš„è¿˜æ²¡æ¥å¾—åŠçœ‹ï¼ŒMacOSä¸Šæœ€è®©æˆ‘å¼€å¿ƒçš„æ˜¯é’ˆå¯¹å„ç§NSButtonçš„Statusçš„æ”¹å˜ã€‚
3.1æ—¶æœŸä½¿ç”¨NSCheckBoxçš„æ—¶å€™åœ¨StoryBoardä¸­æŸ¥çœ‹å®ƒçš„ç›¸å…³å±æ€§å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå«åšStatusçš„å±æ€§ï¼Œæœ‰ä¸‰ä¸ªå€¼ï¼š

* On 
* Off 
* Mixed

OKï¼Œå¤§å®¶éƒ½èƒ½çœ‹æ‡‚ï¼Œç„¶åæ‹–çº¿ä½¿ç”¨æ—¶ï¼Œè·å–senderï¼šNSButtonçš„Statuså°±æˆäº†Intç±»å‹çš„å€¼ã€‚
>0 -> Off ; 1 -> On

è™½ç„¶ä¸å½±å“ä½¿ç”¨ï¼Œä½†æ˜¯ä»ä»£ç çš„é˜…è¯»æ€§ä¸Šæ¥è®²çœŸçš„æ˜¯æ§½ç‚¹å¤ªå¤šã€‚
ä½†æ˜¯æœ¬æ¬¡æ›´æ–°ä¹‹åæˆ‘æ¬£å–œçš„å‘ç°ï¼Œè¿™ä¸ªstatuså˜æˆäº†æšä¸¾âœŒï¸ã€‚

```swift
open var state: NSControl.StateValue
	
```
è¯¸å¦‚æ­¤ç±»è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šNSOpenPanel Beginä¹‹åé—­åŒ…é‡Œé¢çš„resultä¹Ÿä»Intæ¢æˆäº†æšä¸¾ã€‚

ä»è¿™ç‚¹ä¼˜åŒ–æ¥çœ‹ï¼ŒAppleæ˜¯ä¸æ˜¯ç»ˆäºè®°èµ·æ¥ä¼˜åŒ–Cocoaæ¡†æ¶å¤æ‚åˆæ¶å¿ƒçš„APIäº†ï¼Ÿå…·ä½“è¿˜æœ‰ä»€ä¹ˆå˜åŒ–æˆ‘å°±ä¸åºŸè¯äº†ã€‚ä¹‹åç½‘ä¸Šè‚¯å®šæœ‰é“ºå¤©ç›–åœ°å„ç§åšå®¢ç»™å¤§å®¶çœ‹ã€‚

##ç¿»è½¦ç°åœº
è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬æ¥è®²è®²è¿™æ¬¡ç¿»è½¦çš„è¿‡ç¨‹ã€‚æˆ‘ä¸ºäº†ä»XIBä¸­å®ä¾‹åŒ–æˆ‘çš„NSWindowï¼Œç»™NSWinowå†™äº†ä¸€ä¸ªæ‰©å±•æ–¹æ³•å¦‚ä¸‹ï¼š

```swift
extension NSWindow{
    class func loadWithNibName(_ name:String , _ loadClass:AnyClass) -> NSWindow {
        let nib:NSNib = NSNib.init(nibNamed: NSNib.Name(rawValue: name), bundle: nil)!
        var tempObjects = NSArray()
        if (!nib.instantiate(withOwner: nil, topLevelObjects: &tempObjects)){
            return NSWindow()
        }
        for object in tempObjects!{
            
            if (object as AnyObject).classForCoder == loadClass {
                return object as! NSWindow
            }
        }
        return NSWindow()
    }
}
```
å½“æ—¶åˆ‡æ¢åˆ°Swift4.0çš„æ—¶å€™**instantiate(withOwner: nil, topLevelObjects: &tempObjects)**è¿™ä¸ªAPIæŠ¥é”™ï¼Œè¯´&tempObjectsè¿™ä¸ªå‚æ•°çš„ç±»å‹ä¸å¯¹ã€‚äºæ˜¯è·³è¿›å»çœ‹å®šä¹‰ï¼Œå°´å°¬äº†ï¼Œä¹‹å‰è¿™é‡Œè®©ä¼ UnsafePointï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆï¼Œç°åœ¨éœ€è¦ä¼ è¿›å»ä¸€ä¸ª**AutoreleasingUnsafeMutablePointer**æ¯”ä¹‹å‰å¤šäº†ä¸ªAutoreleasing
è¯ä¸å¤šè¯´ï¼ŒXcodeè®©æ€ä¹ˆåŠå°±æ€ä¹ˆåŠå‘—ï¼Œäºæ˜¯ä¿®æ”¹å¦‚ä¸‹ï¼š

```swift

!nib.instantiate(withOwner: nil, topLevelObjects: AutoreleasingUnsafeMutablePointer.init(&tempObjects))
	
```

æ©ã€‚ã€‚ã€‚ç¼–è¯‘é€šè¿‡ï¼Œçœ‹ç€æ²¡ä»€ä¹ˆé—®é¢˜äº†ã€‚è¿è¡Œèµ·æ¥ï¼ç»“æœä½ ä¹ŸçŒœåˆ°äº†ï¼Œå´©æºƒäº†ã€‚å´©æºƒç›´æ¥è¿›äº†AppDelegateã€‚lldbæ²¡æœ‰ä»»ä½•æç¤ºï¼Œäºæ˜¯æœæ–­å…¨å±€æ–­ç‚¹ä¼ºå€™ï¼Œæ— æ•ˆã€‚è¿˜æ˜¯æ²¡æŠ“åˆ°ã€‚äºæ˜¯ä»”ç»†çœ‹ä¸‹ä»£ç æŠ¥é”™åŸå› ï¼š

>EXC_BADACCESS:è¿™æ˜¯è®¿é—®äº†ä¸€ä¸ªå·²ç»è¢«releaseäº†çš„å¯¹è±¡ã€‚

äºæ˜¯æˆ‘çŒœæµ‹åº”è¯¥æ˜¯è¿™ä¸ªTempObjectsæ•°ç»„è¢«æå‰Releaseäº†ã€‚æ‰“å¼€Schemeçš„ç¼–è¾‘çª—ï¼Œåœ¨Diagnosticsä¸­å‹¾é€‰**Malloc Stack**ï¼Œ**Zombie Objects**è¿™ä¸¤ä¸ªé€‰é¡¹ã€‚ç„¶åæ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯TempObjectsè¢«æå‰é‡Šæ”¾äº†ã€‚
ç»“æœå¦‚ä¸‹ï¼š

<div align="center"><img style="border: 1px solid #dcdcdc" width="500" height="30" src="https://github.com/Khala-wan/Khala-wan.github.io/raw/master/resource/Swift4.0/0.jpg"/></div>

æœç„¶æ˜¯å®ƒè¢«æå‰é‡Šæ”¾äº†ã€‚å¯¹æ¯”ä¹‹å‰çš„ä»£ç å¯ä»¥å‘ç°ï¼Œä½¿ç”¨äº†AutoreleasingUnsafeMutablePointerè¿™ä¸ªç±»å‹ä¹‹åæ‰å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºTempObjectsæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œåœ¨å‡½æ•°æ‰§è¡Œå®Œä¹‹åå°±ä¼šè¢«é‡Šæ”¾ï¼Œåœ¨è¿™ä¹‹å**AutoreleasingUnsafeMutablePointer**åˆè¯•å›¾å»Releaseå®ƒï¼Œæ‰€ä»¥é€ æˆäº†**EXC_BADACCESS**.
äºæ˜¯ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š

```swift
extension NSWindow{
    class func loadWithNibName(_ name:String , _ loadClass:AnyClass) -> NSWindow {
        let nib:NSNib = NSNib.init(nibNamed: NSNib.Name(rawValue: name), bundle: nil)!
        var tempObjects:NSArray? = NSArray()
        if (!nib.instantiate(withOwner: nil, topLevelObjects: &tempObjects)){
            return NSWindow()
        }
        for object in tempObjects!{
            
            if (object as AnyObject).classForCoder == loadClass {
                return object as! NSWindow
            }
        }
        return NSWindow()
    }
}

```
å°†TempObjectsçš„ç±»å‹å£°æ˜æˆOptionalå³å¯ã€‚çœ‹æ¥ä¸èƒ½å…¨éƒ¨å¬ä¿¡Xcodeçš„è‡ªåŠ¨ä¿®å¤ã€‚ğŸ˜‚

##æœ€å
è¿™å°±æ˜¯æˆ‘Swift4.0çš„åˆä½“éªŒå’Œç¬¬ä¸€æ¬¡ç¿»è½¦è¿‡ç¨‹ã€‚Swift4.0å’ŒXcode9è¿˜æœ‰å…¶ä»–æ–°ç‰¹æ€§å’Œå¥½ç©çš„ä¸œè¥¿ï¼Œç›¸ä¿¡è¿‡ä¸äº†å¤šä¹…å¤§å®¶éƒ½ä¼šå°†å®ƒä»¬å‘æ˜å‡ºæ¥çš„ã€‚å°±è¯´è¿™ä¹ˆå¤šï¼Œæˆ‘è¦å»ç©ç©è¿™ä¸¤ä¸ªæ–°ç©å…·äº†ã€‚å“ˆå“ˆã€‚

