<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="utf-8">
<meta name="author" content="ä¸‡åœ£">
<meta name="description" content="è¿™é‡Œæ”¾æ»¡äº†èƒ¡æ€ä¹±æƒ³">
<title> Swift4.0:å°é²œä»¥åŠç¬¬ä¸€æ¬¡ç¿»è½¦çºªå¿µ â€º Khala-Wan`</title>
<link rel="canonical" href="http://localhost:4000/swift4.0/2017/06/08/Swift4.0-fresh/">
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,300italic,400italic" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Gentium+Basic:400,400italic" rel="stylesheet">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/basic.css" rel="stylesheet">
<link href="/highlight.css" rel="stylesheet">
<link href="/index.css" rel="stylesheet">
<link href="/customized.css" rel="stylesheet">
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Khala-Wan`" />


<header>
  <h1><a href="/">Khala-Wan`</a></h1>
  <nav>
    <li><a href="/">Home</a></li><li><a href="/Projects/">Projects</a></li><li><a href="/about/">About me</a></li><li><a href="/archive/">Archive</a></li>
  </nav>
</header>
<main>
  <article class="light">
    <div id="toc"></div>
    	<script src="/toc.js"></script>
		<script type="text/javascript">
			$(document).ready(function() {
    		$('#toc').toc();
		</script>
    <header id="123">
      <h2><a href="/swift4.0/2017/06/08/Swift4.0-fresh/">Swift4.0:å°é²œä»¥åŠç¬¬ä¸€æ¬¡ç¿»è½¦çºªå¿µ</a></h2>
      <span><time datetime="2017-06-08T02:32:01+08:00">Jun 8, 2017</time> â€¢ Swift4.0</span>
    </header>
    <div>
<p>æ˜¨å¤©å‡Œæ™¨WWDC2017åˆšå‘å¸ƒäº†Xcode9 BetaåŒ…å«äº†Swift4.0ï¼Œæ­£å¥½æœ€è¿‘åœ¨åšMacOSçš„é¡¹ç›®ï¼Œå› ä¸ºé¡¹ç›®æ˜¯ä¸ªäººçš„ï¼Œæ‰€ä»¥æœæ–­ç”¨æ¥å°é²œã€‚ä½†æ˜¯æœ€åè¿˜æ˜¯ç¿»è½¦äº†ã€‚æ‰€ä»¥å†™ä¸ªåšå®¢çºªå¿µæˆ‘åœ¨Swift4.0ç¿»çš„ç¬¬ä¸€æ¬¡è½¦ã€‚ğŸ˜‚</p>

<p>##åˆä½“éªŒ
4.0è¿™ä¸€æ¬¡æ›´æ–°çš„å…¼å®¹ç¨‹åº¦ç›¸æ¯”ä¹‹å‰2.3åˆ°3.0é‚£æ¬¡æ›´æ–°çœŸçš„å¯ä»¥è¯´æ˜¯å¾ˆè‰¯å¿ƒäº†ã€‚åœ¨ä¿®æ”¹äº†å·®ä¸å¤š30è¡Œä»£ç ï¼ŒèŠ±è´¹5åˆ†é’Ÿå·¦å³æ—¶é—´ä¹‹åï¼Œé¡¹ç›®å·²ç»å½»åº•å…¼å®¹äº†Swift4.0.è¿™ä¸ªç»“æœçœŸçš„è®©æˆ‘æƒŠè®¶ï¼Œè¿˜ä»¥ä¸ºéœ€è¦èŠ±è´¹ç‚¹åŠŸå¤«å‘¢ã€‚è‡³äºSwift4.0çš„ä¼˜åŒ–ç‚¹ï¼ŒiOSçš„è¿˜æ²¡æ¥å¾—åŠçœ‹ï¼ŒMacOSä¸Šæœ€è®©æˆ‘å¼€å¿ƒçš„æ˜¯é’ˆå¯¹å„ç§NSButtonçš„Statusçš„æ”¹å˜ã€‚
3.1æ—¶æœŸä½¿ç”¨NSCheckBoxçš„æ—¶å€™åœ¨StoryBoardä¸­æŸ¥çœ‹å®ƒçš„ç›¸å…³å±æ€§å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå«åšStatusçš„å±æ€§ï¼Œæœ‰ä¸‰ä¸ªå€¼ï¼š</p>

<ul>
  <li>On</li>
  <li>Off</li>
  <li>Mixed</li>
</ul>

<p>OKï¼Œå¤§å®¶éƒ½èƒ½çœ‹æ‡‚ï¼Œç„¶åæ‹–çº¿ä½¿ç”¨æ—¶ï¼Œè·å–senderï¼šNSButtonçš„Statuså°±æˆäº†Intç±»å‹çš„å€¼ã€‚</p>
<blockquote>
  <p>0 -&gt; Off ; 1 -&gt; On</p>
</blockquote>

<p>è™½ç„¶ä¸å½±å“ä½¿ç”¨ï¼Œä½†æ˜¯ä»ä»£ç çš„é˜…è¯»æ€§ä¸Šæ¥è®²çœŸçš„æ˜¯æ§½ç‚¹å¤ªå¤šã€‚
ä½†æ˜¯æœ¬æ¬¡æ›´æ–°ä¹‹åæˆ‘æ¬£å–œçš„å‘ç°ï¼Œè¿™ä¸ªstatuså˜æˆäº†æšä¸¾âœŒï¸ã€‚</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">open</span> <span class="k">var</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">NSControl</span><span class="o">.</span><span class="kt">StateValue</span>
	
</code></pre>
</div>
<p>è¯¸å¦‚æ­¤ç±»è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šNSOpenPanel Beginä¹‹åé—­åŒ…é‡Œé¢çš„resultä¹Ÿä»Intæ¢æˆäº†æšä¸¾ã€‚</p>

<p>ä»è¿™ç‚¹ä¼˜åŒ–æ¥çœ‹ï¼ŒAppleæ˜¯ä¸æ˜¯ç»ˆäºè®°èµ·æ¥ä¼˜åŒ–Cocoaæ¡†æ¶å¤æ‚åˆæ¶å¿ƒçš„APIäº†ï¼Ÿå…·ä½“è¿˜æœ‰ä»€ä¹ˆå˜åŒ–æˆ‘å°±ä¸åºŸè¯äº†ã€‚ä¹‹åç½‘ä¸Šè‚¯å®šæœ‰é“ºå¤©ç›–åœ°å„ç§åšå®¢ç»™å¤§å®¶çœ‹ã€‚</p>

<p>##ç¿»è½¦ç°åœº
è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬æ¥è®²è®²è¿™æ¬¡ç¿»è½¦çš„è¿‡ç¨‹ã€‚æˆ‘ä¸ºäº†ä»XIBä¸­å®ä¾‹åŒ–æˆ‘çš„NSWindowï¼Œç»™NSWinowå†™äº†ä¸€ä¸ªæ‰©å±•æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">NSWindow</span><span class="p">{</span>
    <span class="kd">class</span> <span class="kd">func</span> <span class="nf">loadWithNibName</span><span class="p">(</span><span class="n">_</span> <span class="nv">name</span><span class="p">:</span><span class="kt">String</span> <span class="p">,</span> <span class="n">_</span> <span class="nv">loadClass</span><span class="p">:</span><span class="kt">AnyClass</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSWindow</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">nib</span><span class="p">:</span><span class="kt">NSNib</span> <span class="o">=</span> <span class="kt">NSNib</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">nibNamed</span><span class="p">:</span> <span class="kt">NSNib</span><span class="o">.</span><span class="kt">Name</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">name</span><span class="p">),</span> <span class="nv">bundle</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span><span class="o">!</span>
        <span class="k">var</span> <span class="nv">tempObjects</span> <span class="o">=</span> <span class="kt">NSArray</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nib</span><span class="o">.</span><span class="nf">instantiate</span><span class="p">(</span><span class="nv">withOwner</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">topLevelObjects</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">tempObjects</span><span class="p">)){</span>
            <span class="k">return</span> <span class="kt">NSWindow</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">object</span> <span class="k">in</span> <span class="n">tempObjects</span><span class="o">!</span><span class="p">{</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">object</span> <span class="k">as</span> <span class="kt">AnyObject</span><span class="p">)</span><span class="o">.</span><span class="n">classForCoder</span> <span class="o">==</span> <span class="n">loadClass</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">object</span> <span class="k">as!</span> <span class="kt">NSWindow</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">NSWindow</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>å½“æ—¶åˆ‡æ¢åˆ°Swift4.0çš„æ—¶å€™<strong>instantiate(withOwner: nil, topLevelObjects: &amp;tempObjects)</strong>è¿™ä¸ªAPIæŠ¥é”™ï¼Œè¯´&amp;tempObjectsè¿™ä¸ªå‚æ•°çš„ç±»å‹ä¸å¯¹ã€‚äºæ˜¯è·³è¿›å»çœ‹å®šä¹‰ï¼Œå°´å°¬äº†ï¼Œä¹‹å‰è¿™é‡Œè®©ä¼ UnsafePointï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆï¼Œç°åœ¨éœ€è¦ä¼ è¿›å»ä¸€ä¸ª<strong>AutoreleasingUnsafeMutablePointer</strong>æ¯”ä¹‹å‰å¤šäº†ä¸ªAutoreleasing
è¯ä¸å¤šè¯´ï¼ŒXcodeè®©æ€ä¹ˆåŠå°±æ€ä¹ˆåŠå‘—ï¼Œäºæ˜¯ä¿®æ”¹å¦‚ä¸‹ï¼š</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code>
<span class="o">!</span><span class="n">nib</span><span class="o">.</span><span class="nf">instantiate</span><span class="p">(</span><span class="nv">withOwner</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">topLevelObjects</span><span class="p">:</span> <span class="kt">AutoreleasingUnsafeMutablePointer</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempObjects</span><span class="p">))</span>
	
</code></pre>
</div>

<p>æ©ã€‚ã€‚ã€‚ç¼–è¯‘é€šè¿‡ï¼Œçœ‹ç€æ²¡ä»€ä¹ˆé—®é¢˜äº†ã€‚è¿è¡Œèµ·æ¥ï¼ç»“æœä½ ä¹ŸçŒœåˆ°äº†ï¼Œå´©æºƒäº†ã€‚å´©æºƒç›´æ¥è¿›äº†AppDelegateã€‚lldbæ²¡æœ‰ä»»ä½•æç¤ºï¼Œäºæ˜¯æœæ–­å…¨å±€æ–­ç‚¹ä¼ºå€™ï¼Œæ— æ•ˆã€‚è¿˜æ˜¯æ²¡æŠ“åˆ°ã€‚äºæ˜¯ä»”ç»†çœ‹ä¸‹ä»£ç æŠ¥é”™åŸå› ï¼š
</p>
<blockquote>
  <p>EXC_BADACCESS:è¿™æ˜¯è®¿é—®äº†ä¸€ä¸ªå·²ç»è¢«releaseäº†çš„å¯¹è±¡ã€‚</p>
</blockquote>

<p>äºæ˜¯æˆ‘çŒœæµ‹åº”è¯¥æ˜¯è¿™ä¸ªTempObjectsæ•°ç»„è¢«æå‰Releaseäº†ã€‚æ‰“å¼€Schemeçš„ç¼–è¾‘çª—ï¼Œåœ¨Diagnosticsä¸­å‹¾é€‰<strong>Malloc Stack</strong>ï¼Œ<strong>Zombie Objects</strong>è¿™ä¸¤ä¸ªé€‰é¡¹ã€‚ç„¶åæ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯TempObjectsè¢«æå‰é‡Šæ”¾äº†ã€‚
ç»“æœå¦‚ä¸‹ï¼š</p>

<div align="center"><img style="border: 1px solid #dcdcdc" width="500" height="30" src="https://github.com/Khala-wan/Khala-wan.github.io/raw/master/resource/Swift4.0/0.jpg" /></div>

<p>æœç„¶æ˜¯å®ƒè¢«æå‰é‡Šæ”¾äº†ã€‚å¯¹æ¯”ä¹‹å‰çš„ä»£ç å¯ä»¥å‘ç°ï¼Œä½¿ç”¨äº†AutoreleasingUnsafeMutablePointerè¿™ä¸ªç±»å‹ä¹‹åæ‰å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºTempObjectsæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œåœ¨å‡½æ•°æ‰§è¡Œå®Œä¹‹åå°±ä¼šè¢«é‡Šæ”¾ï¼Œåœ¨è¿™ä¹‹å<strong>AutoreleasingUnsafeMutablePointer</strong>åˆè¯•å›¾å»Releaseå®ƒï¼Œæ‰€ä»¥é€ æˆäº†<strong>EXC_BADACCESS</strong>.
äºæ˜¯ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">NSWindow</span><span class="p">{</span>
    <span class="kd">class</span> <span class="kd">func</span> <span class="nf">loadWithNibName</span><span class="p">(</span><span class="n">_</span> <span class="nv">name</span><span class="p">:</span><span class="kt">String</span> <span class="p">,</span> <span class="n">_</span> <span class="nv">loadClass</span><span class="p">:</span><span class="kt">AnyClass</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSWindow</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">nib</span><span class="p">:</span><span class="kt">NSNib</span> <span class="o">=</span> <span class="kt">NSNib</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">nibNamed</span><span class="p">:</span> <span class="kt">NSNib</span><span class="o">.</span><span class="kt">Name</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">name</span><span class="p">),</span> <span class="nv">bundle</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span><span class="o">!</span>
        <span class="k">var</span> <span class="nv">tempObjects</span><span class="p">:</span><span class="kt">NSArray</span><span class="p">?</span> <span class="o">=</span> <span class="kt">NSArray</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nib</span><span class="o">.</span><span class="nf">instantiate</span><span class="p">(</span><span class="nv">withOwner</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">topLevelObjects</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">tempObjects</span><span class="p">)){</span>
            <span class="k">return</span> <span class="kt">NSWindow</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">object</span> <span class="k">in</span> <span class="n">tempObjects</span><span class="o">!</span><span class="p">{</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">object</span> <span class="k">as</span> <span class="kt">AnyObject</span><span class="p">)</span><span class="o">.</span><span class="n">classForCoder</span> <span class="o">==</span> <span class="n">loadClass</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">object</span> <span class="k">as!</span> <span class="kt">NSWindow</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">NSWindow</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre>
</div>
<p>å°†TempObjectsçš„ç±»å‹å£°æ˜æˆOptionalå³å¯ã€‚çœ‹æ¥ä¸èƒ½å…¨éƒ¨å¬ä¿¡Xcodeçš„è‡ªåŠ¨ä¿®å¤ã€‚ğŸ˜‚</p>

<p>##æœ€å
è¿™å°±æ˜¯æˆ‘Swift4.0çš„åˆä½“éªŒå’Œç¬¬ä¸€æ¬¡ç¿»è½¦è¿‡ç¨‹ã€‚Swift4.0å’ŒXcode9è¿˜æœ‰å…¶ä»–æ–°ç‰¹æ€§å’Œå¥½ç©çš„ä¸œè¥¿ï¼Œç›¸ä¿¡è¿‡ä¸äº†å¤šä¹…å¤§å®¶éƒ½ä¼šå°†å®ƒä»¬å‘æ˜å‡ºæ¥çš„ã€‚å°±è¯´è¿™ä¹ˆå¤šï¼Œæˆ‘è¦å»ç©ç©è¿™ä¸¤ä¸ªæ–°ç©å…·äº†ã€‚å“ˆå“ˆã€‚</p>


    </div>
    
    <!--  -->
    
    <div id="container"></div>
		<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
		<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
		<script>
			var gitment = new Gitment({
  				id: 'Swift4.0:å°é²œä»¥åŠç¬¬ä¸€æ¬¡ç¿»è½¦çºªå¿µ', // å¯é€‰ã€‚é»˜è®¤ä¸º location.href
  				owner: 'Khala-wan',
  				repo: 'Gitment',
  				oauth: {
    				client_id: '4a573894138f17234910',
    				client_secret: '55d6763ae533805391c04757ba8d925c04f4639d',
  				},
			})
			gitment.render('container');
		</script>
	
	</article>
</main>
<footer>
  <span><a href="http://localhost:4000">ä¸‡åœ£</a></span>
  <span><a href="https://github.com/Khala-wan"><i class="fa fa-github-square"></i></a><a href="http://steamcommunity.com/profiles/76561198086573396/"><i class="fa fa-steam-square"></i></a><a href="http://weibo.com/u/2506284730/home?wvr=5"><i class="fa fa-weibo"></i></a><a href="https://github.com/Khala-wan/Khala-wan.github.io/raw/master/resource/social/weixinQR.jpeg"><i class="fa fa-weixin"></i></a></span>
  <span>Â© 2017</span>
</footer>
